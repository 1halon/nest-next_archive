<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<script defer src="/assets/f049f49f05f85a16e5d3.js?f8080e31c47b49a7e41e"></script><link href="/assets/662587e7b8e3c14cee9b.css?f8080e31c47b49a7e41e" rel="stylesheet"></head>

<body>
<noscript>You need to enable JavaScript to run this app.</noscript>

    <div class="nav">
        <div class="container">
            <div class="logo">Meet</div>
            <div class="links">
                <a href="#" class="link">Premium</a>
                <a href="#" class="link">Status</a>
                <a href="#" class="link">Support</a>
            </div>
            <div class="login">
                <a href="/login" class="button">Login</a>
            </div>
        </div>
    </div>
    <div class="container">
        <video id="1" autoplay muted style="width: 800px;"></video>
        <video id="2" autoplay muted style="width: 800px;"></video>
    </div>

    <div class="buttons">
        <input type="text">
        <button>call</button>
        <button>answer</button>
    </div>

    <script>
        const [local_video, remote_video] = document.querySelectorAll("video"),
            input = document.querySelector("input"),
            [call, answer] = document.querySelectorAll("button");
        const socket = new WebSocket("ws://localhost"),
            connection = new RTCPeerConnection(),
            candidates = [];

        let id, local_stream, remote_stream = new MediaStream();

        socket.send = function () {
            WebSocket.prototype.send.apply(this, arguments);
        }

        socket.addEventListener("message", async function ({ data }) {
            data = await new Promise((resolve) => resolve(JSON.parse(data))).catch(() => data);
            debug("GatewaySocket", data);

            if (data.event === "ID") id = data.id;
            else if (data.event === "CALL") {
                await connection.setRemoteDescription(data.offer);
                await connection.setLocalDescription(await connection.createAnswer());
                candidates.forEach(candidate => socket.send(JSON.stringify({
                    _id: id,
                    event: "ICECANDIDATE",
                    candidate: candidate,
                    to: data.from
                })));
                socket.send(JSON.stringify({
                    _id: id,
                    event: "ANSWER",
                    answer: connection.localDescription,
                    to: data.from,
                }));
            } else if (data.event === "ANSWER") {
                await connection.setRemoteDescription(data.answer);
                candidates.forEach(candidate => socket.send(JSON.stringify({
                    _id: id,
                    event: "ICECANDIDATE",
                    candidate: candidate,
                    to: data.from
                })));
            } else if (data.event === "ICECANDIDATE") {
                await connection.addIceCandidate(new RTCIceCandidate(data.candidate));
            }
        });

        connection.addEventListener("icecandidate", function ({ candidate }) {
            debug("ICECANDIDATE", candidate)
            if (candidate) candidates.push(candidate.toJSON());
        });

        connection.addEventListener("icecandidateerror", function (event) {
            debug("ICECANDIDATE_ERROR", event)
        });

        connection.addEventListener("iceconnectionstatechange", function (event) {
            debug("ICECANDIDATE_ERROR", connection.connectionState, event);
        });

        connection.addEventListener("negotiationneeded", async function (event) {
            debug("NEGOTIATION_NEEDED", event);
            await connection.setLocalDescription(await connection.createOffer());
            socket.send(JSON.stringify({
                _id: id,
                event: "CALL",
                offer: connection.localDescription,
                to: input.value
            }));
        });

        connection.addEventListener("track", function ({ streams, track }) {
            debug("TRACK", streams, track);
            remote_video.srcObject = streams[0];
        });

        call.addEventListener("click", async function () {
            local_stream = await navigator.mediaDevices.getDisplayMedia({ audio: false, video: true });
            local_stream.getTracks().forEach(track => connection.addTrack(track, local_stream));
            local_video.srcObject = local_stream;
            remote_video.srcObject = remote_stream;
        });

        answer.addEventListener("click", function () {

        });

        function debug(title, message, ...args) { console.log(`%c[${title}]`, "color: purple;", message, ...args); }
    </script>
</body>

</html>